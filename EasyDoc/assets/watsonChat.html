<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        #muteButton {
            position: fixed;
            top: 5px;
            right: 10px;
            z-index: 2147483647;
            border: none;
            background: none;
        }
    </style>
  </head>
  <body>
  <button id="muteButton" onclick="muteControl()">
    <img id="buttonIcon" src="mute_on.png" width="30" alt="mute">
  </button>
    <script>
      //chatbot setting
      window.watsonAssistantChatOptions = {
        integrationID: "72a46298-fc0d-43c0-a112-d1bfa38d4dbb",
        region: "eu-gb",
        serviceInstanceID: "4e2cc423-8ef5-4809-b407-f16590e88ebd",
        onLoad: function(instance) {
          instance.render();
          instance.on({ type: 'receive', handler: handleMessageReceive });
        },
        showLauncher: false, // Hide the web chat launcher, you will open the WebView from your mobile application
        openChatByDefault: true, // When the web chat WebView is opened, the web chat will already be open and ready to go.
        hideCloseButton: true // And the web chat will not show a close button, instead relying on the controls to close the WebView
      };

      let currentAudio = null;
      let flagMute = true;

      //get response of chatbot
      function generateTextFromMessage(message) {
        return message.output.generic.map(message => message.text).join(' ');
      }
      //get audio from ibm cloud TTS
      function speakText(text) {
        const apiKey = "bD64TXZXdKLWQ1gJ6qZjJT96JnCvZZi6pDOTeoygasA9";
        const url = "https://api.eu-gb.text-to-speech.watson.cloud.ibm.com/instances/728eb365-d9b9-46a4-95e5-1d107fa503fa";
        fetch(url + "/v1/synthesize?accept=audio/mp3&text=" + text + "&voice=en-US_AllisonV3Voice", {
          method: "GET",
          headers: {
            "Authorization": "Basic " + btoa("apikey:" + apiKey)//Authentication using apikey
          }
        })
        .then(response => response.blob())
        .then(response => {
          if (currentAudio) {
            currentAudio.pause(); // stop current audio if it is playing
          }
          const audioUrl = URL.createObjectURL(response);
          currentAudio = new Audio(audioUrl);
          currentAudio.play();
        })
      }
      //play audio
      function handleMessageReceive(event) {
        const synthText = generateTextFromMessage(event.data);
        if(!flagMute){
          speakText(synthText);
        }
      }
      //button control
      function muteControl() {
        flagMute = !flagMute;
        const img = document.getElementById("buttonIcon");
        if(!flagMute){
          img.src = "mute_off.png";
        }
        else{
          img.src = "mute_on.png";
        }
      }
      setTimeout(function() {
        setTimeout(function(){const t=document.createElement('script');t.src="https://web-chat.global.assistant.watson.appdomain.cloud/versions/" + (window.watsonAssistantChatOptions.clientVersion || 'latest') + "/WatsonAssistantChatEntry.js";document.head.appendChild(t);});
      });
    </script>
  </body>
</html>
